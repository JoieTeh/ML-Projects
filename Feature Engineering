{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "152d6016-2ffd-4551-9715-006ff22db53a",
   "metadata": {
    "jp-MarkdownHeadingCollapsed": true,
    "tags": []
   },
   "source": [
    "### Datatypes and Columns Schema"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "7ac42622-f2e2-4066-a080-7898e8d8078a",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "\n",
       "            <div>\n",
       "                <p><b>SparkSession - hive</b></p>\n",
       "                \n",
       "        <div>\n",
       "            <p><b>SparkContext</b></p>\n",
       "\n",
       "            <p><a href=\"http://cluster-jteh-m.us-central1-f.c.joie-teh-project-cis.internal:38841\">Spark UI</a></p>\n",
       "\n",
       "            <dl>\n",
       "              <dt>Version</dt>\n",
       "                <dd><code>v3.5.1</code></dd>\n",
       "              <dt>Master</dt>\n",
       "                <dd><code>yarn</code></dd>\n",
       "              <dt>AppName</dt>\n",
       "                <dd><code>PySparkShell</code></dd>\n",
       "            </dl>\n",
       "        </div>\n",
       "        \n",
       "            </div>\n",
       "        "
      ],
      "text/plain": [
       "<pyspark.sql.session.SparkSession at 0x7fd20d228c50>"
      ]
     },
     "execution_count": 1,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "spark"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "165c7f1b-c209-4f65-ace7-d28c6b6de22e",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "import io\n",
    "import pandas as pd\n",
    "import matplotlib.pyplot as plt\n",
    "import seaborn as sns"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "050fac75-4707-4010-9dc7-7cd9a3320a23",
   "metadata": {
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Import some modules we will need later on\n",
    "from pyspark.sql.functions import col, isnan, when, count, udf, to_date, year, month, date_format, size, split\n",
    "from pyspark.ml.stat import Correlation\n",
    "from pyspark.ml.feature import VectorAssembler, StringIndexer, OneHotEncoder, MinMaxScaler\n",
    "from pyspark.sql import SparkSession\n",
    "from google.cloud import storage"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "6b4686ee-d96a-4583-8432-1e47b2202bf0",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                                                \r"
     ]
    }
   ],
   "source": [
    "#Read only 2019 cleaned trip data's files\n",
    "sdf = spark.read.parquet(\"XXX/fhvhv_tripdata_2019-*.parquet_cleaned.parquet\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "6d14bdd0-05a1-452c-b967-59ab555bb82a",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "root\n",
      " |-- hvfhs_license_num: string (nullable = true)\n",
      " |-- dispatching_base_num: string (nullable = true)\n",
      " |-- request_datetime: timestamp_ntz (nullable = true)\n",
      " |-- pickup_datetime: timestamp_ntz (nullable = true)\n",
      " |-- dropoff_datetime: timestamp_ntz (nullable = true)\n",
      " |-- PULocationID: long (nullable = true)\n",
      " |-- DOLocationID: long (nullable = true)\n",
      " |-- trip_miles: double (nullable = true)\n",
      " |-- trip_time: long (nullable = true)\n",
      " |-- base_passenger_fare: double (nullable = true)\n",
      " |-- tolls: double (nullable = true)\n",
      " |-- bcf: double (nullable = true)\n",
      " |-- sales_tax: double (nullable = true)\n",
      " |-- congestion_surcharge: double (nullable = true)\n",
      " |-- tips: double (nullable = true)\n",
      " |-- driver_pay: double (nullable = true)\n",
      " |-- shared_request_flag: string (nullable = true)\n",
      " |-- shared_match_flag: string (nullable = true)\n",
      " |-- wav_request_flag: string (nullable = true)\n",
      "\n"
     ]
    }
   ],
   "source": [
    "sdf.printSchema()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "a1f82e7a-4018-44dc-be8b-b05b4192cbed",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "['hvfhs_license_num',\n",
       " 'dispatching_base_num',\n",
       " 'request_datetime',\n",
       " 'pickup_datetime',\n",
       " 'dropoff_datetime',\n",
       " 'PULocationID',\n",
       " 'DOLocationID',\n",
       " 'trip_miles',\n",
       " 'trip_time',\n",
       " 'base_passenger_fare',\n",
       " 'tolls',\n",
       " 'bcf',\n",
       " 'sales_tax',\n",
       " 'congestion_surcharge',\n",
       " 'tips',\n",
       " 'driver_pay',\n",
       " 'shared_request_flag',\n",
       " 'shared_match_flag',\n",
       " 'wav_request_flag']"
      ]
     },
     "execution_count": 6,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "sdf.columns"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "c047ced4-9426-4090-8c5a-737a47f4a76e",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                                                \r"
     ]
    },
    {
     "data": {
      "text/plain": [
       "206972656"
      ]
     },
     "execution_count": 7,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "#TOTAL NUMBER OF ROWS = 206 MILION\n",
    "sdf.count()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "37d4778b-ccec-46d6-b595-fb765fc480fc",
   "metadata": {
    "jp-MarkdownHeadingCollapsed": true,
    "tags": []
   },
   "source": [
    "### List of columns by dtype\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "390008b2-db84-45e9-80b5-27177d7fc3cb",
   "metadata": {},
   "outputs": [],
   "source": [
    "# String\n",
    "string_sdf = ['hvfhs_license_num','dispatching_base_num', 'shared_request_flag', 'shared_match_flag', 'wav_request_flag', 'yearmonth', 'dayofweek']\n",
    "\n",
    "#Integer\n",
    "int_sdf = [ 'PULocationID', 'DOLocationID', 'year', 'month']\n",
    "\n",
    "#Datetime\n",
    "date_sdf = ['pickup_datetime', 'dropoff_datetime', 'request_datetime']\n",
    "\n",
    "#Float/double\n",
    "float_sdf = ['trip_miles','trip_time','base_passenger_fare','tolls','bcf', 'sales_tax', 'congestion_surcharge', 'airport_fee','tips','driver_pay', 'weekend'] #Note: Weekend only has binary values 1.0 or 0.0\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "278fe923-0c2b-4852-b00f-651792fba930",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "root\n",
      " |-- hvfhs_license_num: string (nullable = true)\n",
      " |-- dispatching_base_num: string (nullable = true)\n",
      " |-- request_datetime: timestamp_ntz (nullable = true)\n",
      " |-- pickup_datetime: timestamp_ntz (nullable = true)\n",
      " |-- dropoff_datetime: timestamp_ntz (nullable = true)\n",
      " |-- PULocationID: long (nullable = true)\n",
      " |-- DOLocationID: long (nullable = true)\n",
      " |-- trip_miles: double (nullable = true)\n",
      " |-- trip_time: double (nullable = true)\n",
      " |-- base_passenger_fare: double (nullable = true)\n",
      " |-- tolls: double (nullable = true)\n",
      " |-- bcf: double (nullable = true)\n",
      " |-- sales_tax: double (nullable = true)\n",
      " |-- congestion_surcharge: double (nullable = true)\n",
      " |-- tips: double (nullable = true)\n",
      " |-- driver_pay: double (nullable = true)\n",
      " |-- shared_request_flag: string (nullable = true)\n",
      " |-- shared_match_flag: string (nullable = true)\n",
      " |-- wav_request_flag: string (nullable = true)\n",
      "\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                                                \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "+-----------------+--------------------+-------------------+-------------------+-------------------+------------+------------+----------+---------+-------------------+-----+----+---------+--------------------+----+----------+-------------------+-----------------+----------------+\n",
      "|hvfhs_license_num|dispatching_base_num|   request_datetime|    pickup_datetime|   dropoff_datetime|PULocationID|DOLocationID|trip_miles|trip_time|base_passenger_fare|tolls| bcf|sales_tax|congestion_surcharge|tips|driver_pay|shared_request_flag|shared_match_flag|wav_request_flag|\n",
      "+-----------------+--------------------+-------------------+-------------------+-------------------+------------+------------+----------+---------+-------------------+-----+----+---------+--------------------+----+----------+-------------------+-----------------+----------------+\n",
      "|           HV0003|              B02867|2019-02-01 00:01:26|2019-02-01 00:05:18|2019-02-01 00:14:57|         245|         251|      2.45|    579.0|               9.35|  0.0|0.23|     0.83|                 0.0| 0.0|      7.48|                  Y|                N|               N|\n",
      "|           HV0003|              B02879|2019-02-01 00:26:08|2019-02-01 00:41:29|2019-02-01 00:49:39|         216|         197|      1.71|    490.0|               7.91|  0.0| 0.2|      0.7|                 0.0| 2.0|      7.93|                  N|                N|               N|\n",
      "|           HV0005|              B02510|2019-02-01 00:48:58|2019-02-01 00:51:34|2019-02-01 01:28:29|         261|         234|      5.01|   2159.0|              44.96|  0.0|1.12|     3.99|                 0.0| 0.0|     35.97|                  N|                Y|               N|\n",
      "|           HV0005|              B02510|2019-02-01 00:02:15|2019-02-01 00:03:51|2019-02-01 00:07:16|          87|          87|      0.34|    179.0|               7.19|  0.0|0.18|     0.64|                 0.0| 3.0|      5.39|                  N|                Y|               N|\n",
      "|           HV0005|              B02510|2019-02-01 00:06:17|2019-02-01 00:09:44|2019-02-01 00:39:56|          87|         198|      6.84|   1799.0|              24.25| 0.11|0.61|     2.16|                 0.0| 4.0|     17.07|                  N|                Y|               N|\n",
      "|           HV0005|              B02510|2019-02-01 00:07:17|2019-02-01 00:12:06|2019-02-01 00:42:13|         161|         148|      4.53|   1799.0|              16.39|  0.0|0.41|     1.45|                 0.0| 0.0|     14.31|                  N|                Y|               N|\n",
      "|           HV0005|              B02510|2019-02-01 00:43:33|2019-02-01 00:45:35|2019-02-01 01:14:56|         148|          21|     11.24|   1739.0|              29.77| 0.72|0.76|     2.71|                 0.0| 0.0|     22.09|                  N|                Y|               N|\n",
      "|           HV0003|              B02867|2019-02-01 00:00:35|2019-02-01 00:10:48|2019-02-01 00:20:23|         226|         260|      1.59|    574.0|               6.99|  0.0|0.17|     0.62|                 0.0| 0.0|      6.51|                  Y|                N|               N|\n",
      "|           HV0003|              B02867|2019-02-01 00:29:16|2019-02-01 00:32:32|2019-02-01 00:40:25|           7|         223|       1.9|    474.0|               7.05|  0.0|0.18|     0.63|                 0.0| 0.0|      6.01|                  Y|                N|               N|\n",
      "|           HV0003|              B02867|2019-02-01 00:55:48|2019-02-01 00:59:54|2019-02-01 01:09:31|         129|          70|      2.74|    576.0|              10.36|  0.0|0.26|     0.92|                 0.0| 0.0|      7.77|                  N|                N|               N|\n",
      "|           HV0003|              B02764|2019-01-31 23:58:20|2019-02-01 00:01:11|2019-02-01 00:21:35|         263|         229|      7.91|   1225.0|               9.48|  0.0|0.63|     2.22|                 0.0| 0.0|     20.05|                  N|                N|               N|\n",
      "|           HV0003|              B02764|2019-02-01 00:33:43|2019-02-01 00:36:22|2019-02-01 00:55:30|         162|         129|      7.21|   1148.0|              20.69| 5.76|0.66|     2.35|                 0.0| 0.0|     23.16|                  N|                N|               N|\n",
      "|           HV0002|              B02914|2019-02-01 00:05:50|2019-02-01 00:10:09|2019-02-01 00:31:04|         161|          33|      6.93|   1254.0|              21.46|  0.0|0.47|     1.71|                 0.0|3.55|     17.71|                  N|                N|               N|\n",
      "|           HV0003|              B02864|2019-02-01 00:54:59|2019-02-01 00:57:50|2019-02-01 01:05:08|         258|         197|      2.16|    438.0|                8.5|  0.0|0.21|     0.75|                 0.0| 0.0|      5.99|                  N|                N|               N|\n",
      "|           HV0003|              B02875|2019-01-31 23:59:01|2019-02-01 00:05:24|2019-02-01 00:17:13|         255|          17|      2.92|    710.0|              11.51|  0.0|0.29|     1.02|                 0.0| 0.0|      8.53|                  N|                N|               N|\n",
      "|           HV0003|              B02875|2019-02-01 00:24:04|2019-02-01 00:27:38|2019-02-01 00:32:36|         255|         112|      1.09|    298.0|               3.92|  0.0| 0.1|     0.35|                 0.0| 0.0|      5.64|                  Y|                N|               N|\n",
      "|           HV0003|              B02875|2019-02-01 00:47:49|2019-02-01 00:52:50|2019-02-01 00:56:02|         234|         137|      0.37|    192.0|               7.81|  0.0| 0.2|     0.69|                 0.0| 0.0|      6.11|                  N|                N|               N|\n",
      "|           HV0003|              B02682|2019-02-01 00:25:04|2019-02-01 00:30:24|2019-02-01 00:59:08|         163|         256|      8.09|   1724.0|              26.34| 5.76| 0.8|     2.85|                 0.0| 0.0|     28.99|                  N|                N|               N|\n",
      "|           HV0003|              B02682|2019-02-01 00:32:37|2019-02-01 00:35:06|2019-02-01 00:44:27|         161|         262|       2.4|    561.0|              22.16|  0.0|0.55|     1.97|                 0.0| 0.0|     16.35|                  N|                N|               N|\n",
      "|           HV0003|              B02764|2019-01-31 23:57:50|2019-02-01 00:12:54|2019-02-01 00:22:32|           4|         114|      1.17|    577.0|               5.85|  0.0|0.15|     0.52|                 0.0| 5.0|      12.2|                  N|                N|               N|\n",
      "+-----------------+--------------------+-------------------+-------------------+-------------------+------------+------------+----------+---------+-------------------+-----+----+---------+--------------------+----+----------+-------------------+-----------------+----------------+\n",
      "only showing top 20 rows\n",
      "\n"
     ]
    }
   ],
   "source": [
    "from pyspark.sql.functions import col\n",
    "\n",
    "# Apply DoubleType to both 'trip_time' and 'airport_fee'\n",
    "sdf = sdf.withColumn(\"trip_time\", col(\"trip_time\").cast(\"double\"))\n",
    "\n",
    "# Show the schema and data to confirm the changes\n",
    "sdf.printSchema()\n",
    "sdf.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "8ac063fe-6a4f-4127-847e-005c9e96f5d1",
   "metadata": {
    "jp-MarkdownHeadingCollapsed": true,
    "tags": []
   },
   "source": [
    "### Extracting date time features"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "618cf62e-01fb-4d5a-8f74-6eecd6d820fa",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "[Stage 5:>                                                          (0 + 1) / 1]\r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "+----+-----+---------+---------+-------+\n",
      "|year|month|yearmonth|dayofweek|weekend|\n",
      "+----+-----+---------+---------+-------+\n",
      "|2019|    2|  2019-02|   Friday|    0.0|\n",
      "|2019|    2|  2019-02|   Friday|    0.0|\n",
      "|2019|    2|  2019-02|   Friday|    0.0|\n",
      "|2019|    2|  2019-02|   Friday|    0.0|\n",
      "|2019|    2|  2019-02|   Friday|    0.0|\n",
      "|2019|    2|  2019-02|   Friday|    0.0|\n",
      "|2019|    2|  2019-02|   Friday|    0.0|\n",
      "|2019|    2|  2019-02|   Friday|    0.0|\n",
      "|2019|    2|  2019-02|   Friday|    0.0|\n",
      "|2019|    2|  2019-02|   Friday|    0.0|\n",
      "|2019|    2|  2019-02|   Friday|    0.0|\n",
      "|2019|    2|  2019-02|   Friday|    0.0|\n",
      "|2019|    2|  2019-02|   Friday|    0.0|\n",
      "|2019|    2|  2019-02|   Friday|    0.0|\n",
      "|2019|    2|  2019-02|   Friday|    0.0|\n",
      "|2019|    2|  2019-02|   Friday|    0.0|\n",
      "|2019|    2|  2019-02|   Friday|    0.0|\n",
      "|2019|    2|  2019-02|   Friday|    0.0|\n",
      "|2019|    2|  2019-02|   Friday|    0.0|\n",
      "|2019|    2|  2019-02|   Friday|    0.0|\n",
      "+----+-----+---------+---------+-------+\n",
      "only showing top 20 rows\n",
      "\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                                                \r"
     ]
    }
   ],
   "source": [
    "# 1. Extract date and time features (Year, Month, Day, Day of Week, Quarter, Hour)\n",
    "sdf = sdf.withColumn(\"year\", year(col(\"pickup_datetime\")))\n",
    "sdf = sdf.withColumn(\"month\", month(col(\"pickup_datetime\")))   # Numeric month like 11\n",
    "sdf = sdf.withColumn(\"yearmonth\", date_format(col(\"pickup_datetime\"), \"yyyy-MM\"))   # Like 2023-01   2023-02 etc.\n",
    "sdf = sdf.withColumn(\"dayofweek\", date_format(col(\"pickup_datetime\"), \"EEEE\"))         # 'Monday' 'Tuesday' etc.\n",
    "sdf = sdf.withColumn(\"weekend\", when(sdf.dayofweek == 'Saturday',1.0).when(sdf.dayofweek == 'Sunday', 1.0).otherwise(0))\n",
    "\n",
    "# Check columns to see if we got good values\n",
    "sdf.select([\"year\", \"month\", \"yearmonth\", \"dayofweek\", \"weekend\"]).show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "e456f7d6-6828-47f6-9f93-89d90f549752",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "root\n",
      " |-- hvfhs_license_num: string (nullable = true)\n",
      " |-- dispatching_base_num: string (nullable = true)\n",
      " |-- request_datetime: timestamp_ntz (nullable = true)\n",
      " |-- pickup_datetime: timestamp_ntz (nullable = true)\n",
      " |-- dropoff_datetime: timestamp_ntz (nullable = true)\n",
      " |-- PULocationID: long (nullable = true)\n",
      " |-- DOLocationID: long (nullable = true)\n",
      " |-- trip_miles: double (nullable = true)\n",
      " |-- trip_time: double (nullable = true)\n",
      " |-- base_passenger_fare: double (nullable = true)\n",
      " |-- tolls: double (nullable = true)\n",
      " |-- bcf: double (nullable = true)\n",
      " |-- sales_tax: double (nullable = true)\n",
      " |-- congestion_surcharge: double (nullable = true)\n",
      " |-- tips: double (nullable = true)\n",
      " |-- driver_pay: double (nullable = true)\n",
      " |-- shared_request_flag: string (nullable = true)\n",
      " |-- shared_match_flag: string (nullable = true)\n",
      " |-- wav_request_flag: string (nullable = true)\n",
      " |-- year: integer (nullable = true)\n",
      " |-- month: integer (nullable = true)\n",
      " |-- yearmonth: string (nullable = true)\n",
      " |-- dayofweek: string (nullable = true)\n",
      " |-- weekend: double (nullable = false)\n",
      "\n"
     ]
    }
   ],
   "source": [
    "#UPDATED Schema with new datetime extractions\n",
    "sdf.printSchema()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "0f5be860-a679-403c-9adb-2b8ead4b2052",
   "metadata": {
    "jp-MarkdownHeadingCollapsed": true,
    "tags": []
   },
   "source": [
    "### String Indexer"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "e31a0b9b-a939-4019-8927-e4c532016559",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "24/11/14 22:33:13 WARN SparkStringUtils: Truncated the string representation of a plan since it was too large. This behavior can be adjusted by setting 'spark.sql.debug.maxToStringFields'.\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "+-----------------+--------------------+-------------------+-------------------+-------------------+------------+------------+----------+---------+-------------------+-----+----+---------+--------------------+----+----------+-------------------+-----------------+----------------+----+-----+---------+---------+-------+-----------------------+--------------------------+-------------------------+-----------------------+----------------------+---------------+---------------+\n",
      "|hvfhs_license_num|dispatching_base_num|   request_datetime|    pickup_datetime|   dropoff_datetime|PULocationID|DOLocationID|trip_miles|trip_time|base_passenger_fare|tolls| bcf|sales_tax|congestion_surcharge|tips|driver_pay|shared_request_flag|shared_match_flag|wav_request_flag|year|month|yearmonth|dayofweek|weekend|hvfhs_license_num_index|dispatching_base_num_index|shared_request_flag_index|shared_match_flag_index|wav_request_flag_index|yearmonth_index|dayofweek_index|\n",
      "+-----------------+--------------------+-------------------+-------------------+-------------------+------------+------------+----------+---------+-------------------+-----+----+---------+--------------------+----+----------+-------------------+-----------------+----------------+----+-----+---------+---------+-------+-----------------------+--------------------------+-------------------------+-----------------------+----------------------+---------------+---------------+\n",
      "|           HV0003|              B02867|2019-02-01 00:01:26|2019-02-01 00:05:18|2019-02-01 00:14:57|         245|         251|      2.45|    579.0|               9.35|  0.0|0.23|     0.83|                 0.0| 0.0|      7.48|                  Y|                N|               N|2019|    2|  2019-02|   Friday|    0.0|                    0.0|                      20.0|                      1.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|           HV0003|              B02879|2019-02-01 00:26:08|2019-02-01 00:41:29|2019-02-01 00:49:39|         216|         197|      1.71|    490.0|               7.91|  0.0| 0.2|      0.7|                 0.0| 2.0|      7.93|                  N|                N|               N|2019|    2|  2019-02|   Friday|    0.0|                    0.0|                      18.0|                      0.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|           HV0005|              B02510|2019-02-01 00:48:58|2019-02-01 00:51:34|2019-02-01 01:28:29|         261|         234|      5.01|   2159.0|              44.96|  0.0|1.12|     3.99|                 0.0| 0.0|     35.97|                  N|                Y|               N|2019|    2|  2019-02|   Friday|    0.0|                    1.0|                       0.0|                      0.0|                    1.0|                   0.0|            7.0|            1.0|\n",
      "|           HV0005|              B02510|2019-02-01 00:02:15|2019-02-01 00:03:51|2019-02-01 00:07:16|          87|          87|      0.34|    179.0|               7.19|  0.0|0.18|     0.64|                 0.0| 3.0|      5.39|                  N|                Y|               N|2019|    2|  2019-02|   Friday|    0.0|                    1.0|                       0.0|                      0.0|                    1.0|                   0.0|            7.0|            1.0|\n",
      "|           HV0005|              B02510|2019-02-01 00:06:17|2019-02-01 00:09:44|2019-02-01 00:39:56|          87|         198|      6.84|   1799.0|              24.25| 0.11|0.61|     2.16|                 0.0| 4.0|     17.07|                  N|                Y|               N|2019|    2|  2019-02|   Friday|    0.0|                    1.0|                       0.0|                      0.0|                    1.0|                   0.0|            7.0|            1.0|\n",
      "|           HV0005|              B02510|2019-02-01 00:07:17|2019-02-01 00:12:06|2019-02-01 00:42:13|         161|         148|      4.53|   1799.0|              16.39|  0.0|0.41|     1.45|                 0.0| 0.0|     14.31|                  N|                Y|               N|2019|    2|  2019-02|   Friday|    0.0|                    1.0|                       0.0|                      0.0|                    1.0|                   0.0|            7.0|            1.0|\n",
      "|           HV0005|              B02510|2019-02-01 00:43:33|2019-02-01 00:45:35|2019-02-01 01:14:56|         148|          21|     11.24|   1739.0|              29.77| 0.72|0.76|     2.71|                 0.0| 0.0|     22.09|                  N|                Y|               N|2019|    2|  2019-02|   Friday|    0.0|                    1.0|                       0.0|                      0.0|                    1.0|                   0.0|            7.0|            1.0|\n",
      "|           HV0003|              B02867|2019-02-01 00:00:35|2019-02-01 00:10:48|2019-02-01 00:20:23|         226|         260|      1.59|    574.0|               6.99|  0.0|0.17|     0.62|                 0.0| 0.0|      6.51|                  Y|                N|               N|2019|    2|  2019-02|   Friday|    0.0|                    0.0|                      20.0|                      1.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|           HV0003|              B02867|2019-02-01 00:29:16|2019-02-01 00:32:32|2019-02-01 00:40:25|           7|         223|       1.9|    474.0|               7.05|  0.0|0.18|     0.63|                 0.0| 0.0|      6.01|                  Y|                N|               N|2019|    2|  2019-02|   Friday|    0.0|                    0.0|                      20.0|                      1.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|           HV0003|              B02867|2019-02-01 00:55:48|2019-02-01 00:59:54|2019-02-01 01:09:31|         129|          70|      2.74|    576.0|              10.36|  0.0|0.26|     0.92|                 0.0| 0.0|      7.77|                  N|                N|               N|2019|    2|  2019-02|   Friday|    0.0|                    0.0|                      20.0|                      0.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|           HV0003|              B02764|2019-01-31 23:58:20|2019-02-01 00:01:11|2019-02-01 00:21:35|         263|         229|      7.91|   1225.0|               9.48|  0.0|0.63|     2.22|                 0.0| 0.0|     20.05|                  N|                N|               N|2019|    2|  2019-02|   Friday|    0.0|                    0.0|                       1.0|                      0.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|           HV0003|              B02764|2019-02-01 00:33:43|2019-02-01 00:36:22|2019-02-01 00:55:30|         162|         129|      7.21|   1148.0|              20.69| 5.76|0.66|     2.35|                 0.0| 0.0|     23.16|                  N|                N|               N|2019|    2|  2019-02|   Friday|    0.0|                    0.0|                       1.0|                      0.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|           HV0002|              B02914|2019-02-01 00:05:50|2019-02-01 00:10:09|2019-02-01 00:31:04|         161|          33|      6.93|   1254.0|              21.46|  0.0|0.47|     1.71|                 0.0|3.55|     17.71|                  N|                N|               N|2019|    2|  2019-02|   Friday|    0.0|                    2.0|                      29.0|                      0.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|           HV0003|              B02864|2019-02-01 00:54:59|2019-02-01 00:57:50|2019-02-01 01:05:08|         258|         197|      2.16|    438.0|                8.5|  0.0|0.21|     0.75|                 0.0| 0.0|      5.99|                  N|                N|               N|2019|    2|  2019-02|   Friday|    0.0|                    0.0|                       9.0|                      0.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|           HV0003|              B02875|2019-01-31 23:59:01|2019-02-01 00:05:24|2019-02-01 00:17:13|         255|          17|      2.92|    710.0|              11.51|  0.0|0.29|     1.02|                 0.0| 0.0|      8.53|                  N|                N|               N|2019|    2|  2019-02|   Friday|    0.0|                    0.0|                       3.0|                      0.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|           HV0003|              B02875|2019-02-01 00:24:04|2019-02-01 00:27:38|2019-02-01 00:32:36|         255|         112|      1.09|    298.0|               3.92|  0.0| 0.1|     0.35|                 0.0| 0.0|      5.64|                  Y|                N|               N|2019|    2|  2019-02|   Friday|    0.0|                    0.0|                       3.0|                      1.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|           HV0003|              B02875|2019-02-01 00:47:49|2019-02-01 00:52:50|2019-02-01 00:56:02|         234|         137|      0.37|    192.0|               7.81|  0.0| 0.2|     0.69|                 0.0| 0.0|      6.11|                  N|                N|               N|2019|    2|  2019-02|   Friday|    0.0|                    0.0|                       3.0|                      0.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|           HV0003|              B02682|2019-02-01 00:25:04|2019-02-01 00:30:24|2019-02-01 00:59:08|         163|         256|      8.09|   1724.0|              26.34| 5.76| 0.8|     2.85|                 0.0| 0.0|     28.99|                  N|                N|               N|2019|    2|  2019-02|   Friday|    0.0|                    0.0|                       7.0|                      0.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|           HV0003|              B02682|2019-02-01 00:32:37|2019-02-01 00:35:06|2019-02-01 00:44:27|         161|         262|       2.4|    561.0|              22.16|  0.0|0.55|     1.97|                 0.0| 0.0|     16.35|                  N|                N|               N|2019|    2|  2019-02|   Friday|    0.0|                    0.0|                       7.0|                      0.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|           HV0003|              B02764|2019-01-31 23:57:50|2019-02-01 00:12:54|2019-02-01 00:22:32|           4|         114|      1.17|    577.0|               5.85|  0.0|0.15|     0.52|                 0.0| 5.0|      12.2|                  N|                N|               N|2019|    2|  2019-02|   Friday|    0.0|                    0.0|                       1.0|                      0.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "+-----------------+--------------------+-------------------+-------------------+-------------------+------------+------------+----------+---------+-------------------+-----+----+---------+--------------------+----+----------+-------------------+-----------------+----------------+----+-----+---------+---------+-------+-----------------------+--------------------------+-------------------------+-----------------------+----------------------+---------------+---------------+\n",
      "only showing top 20 rows\n",
      "\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                                                \r"
     ]
    }
   ],
   "source": [
    "input_cols = ['hvfhs_license_num', 'dispatching_base_num', 'shared_request_flag', \n",
    "              'shared_match_flag', 'wav_request_flag', 'yearmonth', 'dayofweek']\n",
    "\n",
    "output_cols = [col + '_index' for col in input_cols]\n",
    "\n",
    "# Apply StringIndexer and apply transformations\n",
    "indexer = StringIndexer(inputCols=input_cols, outputCols=output_cols)\n",
    "indexed_sdf = indexer.fit(sdf).transform(sdf)\n",
    "\n",
    "# Show the result\n",
    "indexed_sdf.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "25e08517-3d6a-4edc-a0db-fe46fcbf7c64",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "['hvfhs_license_num_index', 'dispatching_base_num_index', 'shared_request_flag_index', 'shared_match_flag_index', 'wav_request_flag_index', 'yearmonth_index', 'dayofweek_index']\n"
     ]
    }
   ],
   "source": [
    "print(output_cols)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "f73438c6-1a5c-43dc-8372-170b91ce799e",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "+-----------------------+--------------------------+-------------------------+-----------------------+----------------------+---------------+---------------+\n",
      "|hvfhs_license_num_index|dispatching_base_num_index|shared_request_flag_index|shared_match_flag_index|wav_request_flag_index|yearmonth_index|dayofweek_index|\n",
      "+-----------------------+--------------------------+-------------------------+-----------------------+----------------------+---------------+---------------+\n",
      "|                    0.0|                      20.0|                      1.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|                    0.0|                      18.0|                      0.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|                    1.0|                       0.0|                      0.0|                    1.0|                   0.0|            7.0|            1.0|\n",
      "|                    1.0|                       0.0|                      0.0|                    1.0|                   0.0|            7.0|            1.0|\n",
      "|                    1.0|                       0.0|                      0.0|                    1.0|                   0.0|            7.0|            1.0|\n",
      "|                    1.0|                       0.0|                      0.0|                    1.0|                   0.0|            7.0|            1.0|\n",
      "|                    1.0|                       0.0|                      0.0|                    1.0|                   0.0|            7.0|            1.0|\n",
      "|                    0.0|                      20.0|                      1.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|                    0.0|                      20.0|                      1.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|                    0.0|                      20.0|                      0.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|                    0.0|                       1.0|                      0.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|                    0.0|                       1.0|                      0.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|                    2.0|                      29.0|                      0.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|                    0.0|                       9.0|                      0.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|                    0.0|                       3.0|                      0.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|                    0.0|                       3.0|                      1.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|                    0.0|                       3.0|                      0.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|                    0.0|                       7.0|                      0.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|                    0.0|                       7.0|                      0.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "|                    0.0|                       1.0|                      0.0|                    0.0|                   0.0|            7.0|            1.0|\n",
      "+-----------------------+--------------------------+-------------------------+-----------------------+----------------------+---------------+---------------+\n",
      "only showing top 20 rows\n",
      "\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                                                \r"
     ]
    }
   ],
   "source": [
    "# Show only the newly indexed columns\n",
    "indexed_sdf.select(output_cols).show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "c0cef51f-1c7c-4256-a23e-b9d7c2664126",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "[Stage 11:======================================================> (37 + 1) / 38]\r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Mapping for yearmonth_index: ('2019-03', '2019-05', '2019-12', '2019-04', '2019-11', '2019-06', '2019-10', '2019-02', '2019-09', '2019-07', '2019-08')\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                                                \r"
     ]
    }
   ],
   "source": [
    "### CODE FOR UNDERSTANDING INDEX AND THEIR CORRESPONDING LABELS\n",
    "# Retrieve the StringIndexerModel\n",
    "indexer_model = indexer.fit(sdf)\n",
    "\n",
    "# Access the labelsArray for the 'yearmonth' column (it should be the 6th entry, index 5)\n",
    "yearmonth_labels = indexer_model.labelsArray[5]  # Since 'yearmonth' was the 6th column in input_cols\n",
    "\n",
    "# Print the mapping for yearmonth_index\n",
    "print(f\"Mapping for yearmonth_index: {yearmonth_labels}\")\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "094e973e-ff33-49d1-b761-c5eb12c5187e",
   "metadata": {
    "jp-MarkdownHeadingCollapsed": true,
    "tags": []
   },
   "source": [
    "### One-Hot Encoding + Vector Assembler"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "id": "f7eb233a-8755-4978-99bd-9aaa8ca04931",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "[Stage 18:>                                                         (0 + 1) / 1]\r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "+-------------------+-------------------+-------------------+--------------+------------------------------+---------------------------------+--------------------------------+------------------------------+-----------------------------+----------------------+----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n",
      "|PULocationID_vector|DOLocationID_vector|year_vector        |month_vector  |hvfhs_license_num_index_vector|dispatching_base_num_index_vector|shared_request_flag_index_vector|shared_match_flag_index_vector|wav_request_flag_index_vector|yearmonth_index_vector|dayofweek_index_vector|features                                                                                                                                                                                     |\n",
      "+-------------------+-------------------+-------------------+--------------+------------------------------+---------------------------------+--------------------------------+------------------------------+-----------------------------+----------------------+----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n",
      "|(266,[245],[1.0])  |(266,[251],[1.0])  |(2020,[2019],[1.0])|(13,[2],[1.0])|(4,[0],[1.0])                 |(35,[20],[1.0])                  |(2,[1],[1.0])                   |(2,[0],[1.0])                 |(2,[0],[1.0])                |(11,[7],[1.0])        |(7,[1],[1.0])         |(2638,[245,517,2551,2554,2565,2589,2605,2606,2608,2617,2622,2628,2629,2630,2632,2633,2636],[1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,2.45,579.0,9.35,0.23,0.83,7.48])                     |\n",
      "|(266,[216],[1.0])  |(266,[197],[1.0])  |(2020,[2019],[1.0])|(13,[2],[1.0])|(4,[0],[1.0])                 |(35,[18],[1.0])                  |(2,[0],[1.0])                   |(2,[0],[1.0])                 |(2,[0],[1.0])                |(11,[7],[1.0])        |(7,[1],[1.0])         |(2638,[216,463,2551,2554,2565,2587,2604,2606,2608,2617,2622,2628,2629,2630,2632,2633,2635,2636],[1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.71,490.0,7.91,0.2,0.7,2.0,7.93])              |\n",
      "|(266,[261],[1.0])  |(266,[234],[1.0])  |(2020,[2019],[1.0])|(13,[2],[1.0])|(4,[1],[1.0])                 |(35,[0],[1.0])                   |(2,[0],[1.0])                   |(2,[1],[1.0])                 |(2,[0],[1.0])                |(11,[7],[1.0])        |(7,[1],[1.0])         |(2638,[261,500,2551,2554,2566,2569,2604,2607,2608,2617,2622,2628,2629,2630,2632,2633,2636],[1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,5.01,2159.0,44.96,1.12,3.99,35.97])                  |\n",
      "|(266,[87],[1.0])   |(266,[87],[1.0])   |(2020,[2019],[1.0])|(13,[2],[1.0])|(4,[1],[1.0])                 |(35,[0],[1.0])                   |(2,[0],[1.0])                   |(2,[1],[1.0])                 |(2,[0],[1.0])                |(11,[7],[1.0])        |(7,[1],[1.0])         |(2638,[87,353,2551,2554,2566,2569,2604,2607,2608,2617,2622,2628,2629,2630,2632,2633,2635,2636],[1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,0.34,179.0,7.19,0.18,0.64,3.0,5.39])             |\n",
      "|(266,[87],[1.0])   |(266,[198],[1.0])  |(2020,[2019],[1.0])|(13,[2],[1.0])|(4,[1],[1.0])                 |(35,[0],[1.0])                   |(2,[0],[1.0])                   |(2,[1],[1.0])                 |(2,[0],[1.0])                |(11,[7],[1.0])        |(7,[1],[1.0])         |(2638,[87,464,2551,2554,2566,2569,2604,2607,2608,2617,2622,2628,2629,2630,2631,2632,2633,2635,2636],[1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,6.84,1799.0,24.25,0.11,0.61,2.16,4.0,17.07])|\n",
      "|(266,[161],[1.0])  |(266,[148],[1.0])  |(2020,[2019],[1.0])|(13,[2],[1.0])|(4,[1],[1.0])                 |(35,[0],[1.0])                   |(2,[0],[1.0])                   |(2,[1],[1.0])                 |(2,[0],[1.0])                |(11,[7],[1.0])        |(7,[1],[1.0])         |(2638,[161,414,2551,2554,2566,2569,2604,2607,2608,2617,2622,2628,2629,2630,2632,2633,2636],[1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,4.53,1799.0,16.39,0.41,1.45,14.31])                  |\n",
      "|(266,[148],[1.0])  |(266,[21],[1.0])   |(2020,[2019],[1.0])|(13,[2],[1.0])|(4,[1],[1.0])                 |(35,[0],[1.0])                   |(2,[0],[1.0])                   |(2,[1],[1.0])                 |(2,[0],[1.0])                |(11,[7],[1.0])        |(7,[1],[1.0])         |(2638,[148,287,2551,2554,2566,2569,2604,2607,2608,2617,2622,2628,2629,2630,2631,2632,2633,2636],[1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,11.24,1739.0,29.77,0.72,0.76,2.71,22.09])       |\n",
      "|(266,[226],[1.0])  |(266,[260],[1.0])  |(2020,[2019],[1.0])|(13,[2],[1.0])|(4,[0],[1.0])                 |(35,[20],[1.0])                  |(2,[1],[1.0])                   |(2,[0],[1.0])                 |(2,[0],[1.0])                |(11,[7],[1.0])        |(7,[1],[1.0])         |(2638,[226,526,2551,2554,2565,2589,2605,2606,2608,2617,2622,2628,2629,2630,2632,2633,2636],[1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.59,574.0,6.99,0.17,0.62,6.51])                     |\n",
      "|(266,[7],[1.0])    |(266,[223],[1.0])  |(2020,[2019],[1.0])|(13,[2],[1.0])|(4,[0],[1.0])                 |(35,[20],[1.0])                  |(2,[1],[1.0])                   |(2,[0],[1.0])                 |(2,[0],[1.0])                |(11,[7],[1.0])        |(7,[1],[1.0])         |(2638,[7,489,2551,2554,2565,2589,2605,2606,2608,2617,2622,2628,2629,2630,2632,2633,2636],[1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.9,474.0,7.05,0.18,0.63,6.01])                        |\n",
      "|(266,[129],[1.0])  |(266,[70],[1.0])   |(2020,[2019],[1.0])|(13,[2],[1.0])|(4,[0],[1.0])                 |(35,[20],[1.0])                  |(2,[0],[1.0])                   |(2,[0],[1.0])                 |(2,[0],[1.0])                |(11,[7],[1.0])        |(7,[1],[1.0])         |(2638,[129,336,2551,2554,2565,2589,2604,2606,2608,2617,2622,2628,2629,2630,2632,2633,2636],[1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,2.74,576.0,10.36,0.26,0.92,7.77])                    |\n",
      "|(266,[263],[1.0])  |(266,[229],[1.0])  |(2020,[2019],[1.0])|(13,[2],[1.0])|(4,[0],[1.0])                 |(35,[1],[1.0])                   |(2,[0],[1.0])                   |(2,[0],[1.0])                 |(2,[0],[1.0])                |(11,[7],[1.0])        |(7,[1],[1.0])         |(2638,[263,495,2551,2554,2565,2570,2604,2606,2608,2617,2622,2628,2629,2630,2632,2633,2636],[1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,7.91,1225.0,9.48,0.63,2.22,20.05])                   |\n",
      "|(266,[162],[1.0])  |(266,[129],[1.0])  |(2020,[2019],[1.0])|(13,[2],[1.0])|(4,[0],[1.0])                 |(35,[1],[1.0])                   |(2,[0],[1.0])                   |(2,[0],[1.0])                 |(2,[0],[1.0])                |(11,[7],[1.0])        |(7,[1],[1.0])         |(2638,[162,395,2551,2554,2565,2570,2604,2606,2608,2617,2622,2628,2629,2630,2631,2632,2633,2636],[1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,7.21,1148.0,20.69,5.76,0.66,2.35,23.16])        |\n",
      "|(266,[161],[1.0])  |(266,[33],[1.0])   |(2020,[2019],[1.0])|(13,[2],[1.0])|(4,[2],[1.0])                 |(35,[29],[1.0])                  |(2,[0],[1.0])                   |(2,[0],[1.0])                 |(2,[0],[1.0])                |(11,[7],[1.0])        |(7,[1],[1.0])         |(2638,[161,299,2551,2554,2567,2598,2604,2606,2608,2617,2622,2628,2629,2630,2632,2633,2635,2636],[1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,6.93,1254.0,21.46,0.47,1.71,3.55,17.71])        |\n",
      "|(266,[258],[1.0])  |(266,[197],[1.0])  |(2020,[2019],[1.0])|(13,[2],[1.0])|(4,[0],[1.0])                 |(35,[9],[1.0])                   |(2,[0],[1.0])                   |(2,[0],[1.0])                 |(2,[0],[1.0])                |(11,[7],[1.0])        |(7,[1],[1.0])         |(2638,[258,463,2551,2554,2565,2578,2604,2606,2608,2617,2622,2628,2629,2630,2632,2633,2636],[1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,2.16,438.0,8.5,0.21,0.75,5.99])                      |\n",
      "|(266,[255],[1.0])  |(266,[17],[1.0])   |(2020,[2019],[1.0])|(13,[2],[1.0])|(4,[0],[1.0])                 |(35,[3],[1.0])                   |(2,[0],[1.0])                   |(2,[0],[1.0])                 |(2,[0],[1.0])                |(11,[7],[1.0])        |(7,[1],[1.0])         |(2638,[255,283,2551,2554,2565,2572,2604,2606,2608,2617,2622,2628,2629,2630,2632,2633,2636],[1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,2.92,710.0,11.51,0.29,1.02,8.53])                    |\n",
      "|(266,[255],[1.0])  |(266,[112],[1.0])  |(2020,[2019],[1.0])|(13,[2],[1.0])|(4,[0],[1.0])                 |(35,[3],[1.0])                   |(2,[1],[1.0])                   |(2,[0],[1.0])                 |(2,[0],[1.0])                |(11,[7],[1.0])        |(7,[1],[1.0])         |(2638,[255,378,2551,2554,2565,2572,2605,2606,2608,2617,2622,2628,2629,2630,2632,2633,2636],[1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.09,298.0,3.92,0.1,0.35,5.64])                      |\n",
      "|(266,[234],[1.0])  |(266,[137],[1.0])  |(2020,[2019],[1.0])|(13,[2],[1.0])|(4,[0],[1.0])                 |(35,[3],[1.0])                   |(2,[0],[1.0])                   |(2,[0],[1.0])                 |(2,[0],[1.0])                |(11,[7],[1.0])        |(7,[1],[1.0])         |(2638,[234,403,2551,2554,2565,2572,2604,2606,2608,2617,2622,2628,2629,2630,2632,2633,2636],[1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,0.37,192.0,7.81,0.2,0.69,6.11])                      |\n",
      "|(266,[163],[1.0])  |(266,[256],[1.0])  |(2020,[2019],[1.0])|(13,[2],[1.0])|(4,[0],[1.0])                 |(35,[7],[1.0])                   |(2,[0],[1.0])                   |(2,[0],[1.0])                 |(2,[0],[1.0])                |(11,[7],[1.0])        |(7,[1],[1.0])         |(2638,[163,522,2551,2554,2565,2576,2604,2606,2608,2617,2622,2628,2629,2630,2631,2632,2633,2636],[1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,8.09,1724.0,26.34,5.76,0.8,2.85,28.99])         |\n",
      "|(266,[161],[1.0])  |(266,[262],[1.0])  |(2020,[2019],[1.0])|(13,[2],[1.0])|(4,[0],[1.0])                 |(35,[7],[1.0])                   |(2,[0],[1.0])                   |(2,[0],[1.0])                 |(2,[0],[1.0])                |(11,[7],[1.0])        |(7,[1],[1.0])         |(2638,[161,528,2551,2554,2565,2576,2604,2606,2608,2617,2622,2628,2629,2630,2632,2633,2636],[1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,2.4,561.0,22.16,0.55,1.97,16.35])                    |\n",
      "|(266,[4],[1.0])    |(266,[114],[1.0])  |(2020,[2019],[1.0])|(13,[2],[1.0])|(4,[0],[1.0])                 |(35,[1],[1.0])                   |(2,[0],[1.0])                   |(2,[0],[1.0])                 |(2,[0],[1.0])                |(11,[7],[1.0])        |(7,[1],[1.0])         |(2638,[4,380,2551,2554,2565,2570,2604,2606,2608,2617,2622,2628,2629,2630,2632,2633,2635,2636],[1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.17,577.0,5.85,0.15,0.52,5.0,12.2])              |\n",
      "+-------------------+-------------------+-------------------+--------------+------------------------------+---------------------------------+--------------------------------+------------------------------+-----------------------------+----------------------+----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n",
      "only showing top 20 rows\n",
      "\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                                                \r"
     ]
    }
   ],
   "source": [
    "# OneHotEncoder to encode the indexed columns and integer columns\n",
    "encoder = OneHotEncoder(\n",
    "    inputCols=['PULocationID', 'DOLocationID', 'year', 'month',\n",
    "               'hvfhs_license_num_index', 'dispatching_base_num_index', \n",
    "               'shared_request_flag_index', 'shared_match_flag_index', \n",
    "               'wav_request_flag_index', 'yearmonth_index', 'dayofweek_index'],\n",
    "    outputCols=['PULocationID_vector', 'DOLocationID_vector', 'year_vector', 'month_vector',\n",
    "                'hvfhs_license_num_index_vector', 'dispatching_base_num_index_vector',\n",
    "                'shared_request_flag_index_vector', 'shared_match_flag_index_vector',\n",
    "                'wav_request_flag_index_vector', 'yearmonth_index_vector', 'dayofweek_index_vector'],\n",
    "    dropLast=False  # Keep all categories\n",
    ")\n",
    "\n",
    "# Apply OneHotEncoder transformation\n",
    "encoded_sdf = encoder.fit(indexed_sdf).transform(indexed_sdf)\n",
    "\n",
    "# VectorAssembler to combine the encoded columns and integer columns into a single vector column\n",
    "assembler = VectorAssembler(\n",
    "    inputCols=['PULocationID_vector', 'DOLocationID_vector', 'year_vector', 'month_vector',\n",
    "               'hvfhs_license_num_index_vector', 'dispatching_base_num_index_vector',\n",
    "               'shared_request_flag_index_vector', 'shared_match_flag_index_vector',\n",
    "               'wav_request_flag_index_vector', 'yearmonth_index_vector', 'dayofweek_index_vector',\n",
    "               'trip_miles', 'trip_time', 'base_passenger_fare', 'tolls', 'bcf', 'sales_tax',\n",
    "               'congestion_surcharge', 'tips', 'driver_pay', 'weekend'],  # float columns are included\n",
    "    outputCol=\"features\" \n",
    ")\n",
    "\n",
    "# Apply VectorAssembler transformation\n",
    "assembled_sdf = assembler.transform(encoded_sdf)\n",
    "\n",
    "# Show the resulting DataFrame ( a portion)\n",
    "assembled_sdf.select(['PULocationID_vector', 'DOLocationID_vector', 'year_vector', 'month_vector', \n",
    "                       'hvfhs_license_num_index_vector', 'dispatching_base_num_index_vector', \n",
    "                       'shared_request_flag_index_vector', 'shared_match_flag_index_vector', \n",
    "                       'wav_request_flag_index_vector', 'yearmonth_index_vector', 'dayofweek_index_vector',\n",
    "                       'features']).show(truncate=False)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "73664863-d98f-4050-95e1-60d64788459a",
   "metadata": {
    "jp-MarkdownHeadingCollapsed": true,
    "tags": []
   },
   "source": [
    "### Min-Max Scaling"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "id": "fda5f847-70e5-4627-bd3f-2309af5bc8d6",
   "metadata": {
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "[Stage 46:>                                                         (0 + 1) / 1]\r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "+-----------------+--------------------+-------------------+-------------------+-------------------+------------+------------+----------+---------+-------------------+-----+----+---------+--------------------+----+----------+-------------------+-----------------+----------------+----+-----+---------+---------+-------+-----------------------+--------------------------+-------------------------+-----------------------+----------------------+---------------+---------------+----------------+-----------------------+---------------+-----------------------+-------------------------+--------------------------+-----------+-----------------------+---------+-----------------------+---------------+-----------------------+--------------------------+---------------------------+----------+-----------------------+----------------+----------------------+\n",
      "|hvfhs_license_num|dispatching_base_num|request_datetime   |pickup_datetime    |dropoff_datetime   |PULocationID|DOLocationID|trip_miles|trip_time|base_passenger_fare|tolls|bcf |sales_tax|congestion_surcharge|tips|driver_pay|shared_request_flag|shared_match_flag|wav_request_flag|year|month|yearmonth|dayofweek|weekend|hvfhs_license_num_index|dispatching_base_num_index|shared_request_flag_index|shared_match_flag_index|wav_request_flag_index|yearmonth_index|dayofweek_index|trip_milesVector|trip_miles_scaled      |trip_timeVector|trip_time_scaled       |base_passenger_fareVector|base_passenger_fare_scaled|tollsVector|tolls_scaled           |bcfVector|bcf_scaled             |sales_taxVector|sales_tax_scaled       |congestion_surchargeVector|congestion_surcharge_scaled|tipsVector|tips_scaled            |driver_payVector|driver_pay_scaled     |\n",
      "+-----------------+--------------------+-------------------+-------------------+-------------------+------------+------------+----------+---------+-------------------+-----+----+---------+--------------------+----+----------+-------------------+-----------------+----------------+----+-----+---------+---------+-------+-----------------------+--------------------------+-------------------------+-----------------------+----------------------+---------------+---------------+----------------+-----------------------+---------------+-----------------------+-------------------------+--------------------------+-----------+-----------------------+---------+-----------------------+---------------+-----------------------+--------------------------+---------------------------+----------+-----------------------+----------------+----------------------+\n",
      "|HV0003           |B02867              |2019-02-01 00:01:26|2019-02-01 00:05:18|2019-02-01 00:14:57|245         |251         |2.45      |579.0    |9.35               |0.0  |0.23|0.83     |0.0                 |0.0 |7.48      |Y                  |N                |N               |2019|2    |2019-02  |Friday   |0.0    |0.0                    |20.0                      |1.0                      |0.0                    |0.0                   |7.0            |1.0            |[2.45]          |[0.016327864043363182] |[579.0]        |[0.006872403560830861] |[9.35]                   |[0.011689026832198638]    |[0.0]      |[0.0]                  |[0.23]   |[0.004203216374269006] |[0.83]         |[0.007247642333216905] |[0.0]                     |[0.0]                      |[0.0]     |[0.0]                  |[7.48]          |[0.012484540562222148]|\n",
      "|HV0003           |B02879              |2019-02-01 00:26:08|2019-02-01 00:41:29|2019-02-01 00:49:39|216         |197         |1.71      |490.0    |7.91               |0.0  |0.2 |0.7      |0.0                 |2.0 |7.93      |N                  |N                |N               |2019|2    |2019-02  |Friday   |0.0    |0.0                    |18.0                      |0.0                      |0.0                    |0.0                   |7.0            |1.0            |[1.71]          |[0.011394168905719752] |[490.0]        |[0.005816023738872404] |[7.91]                   |[0.009886864237084502]    |[0.0]      |[0.0]                  |[0.2]    |[0.003654970760233918] |[0.7]          |[0.006112469437652811] |[0.0]                     |[0.0]                      |[2.0]     |[0.004761904761904762] |[7.93]          |[0.013236621318982516]|\n",
      "|HV0005           |B02510              |2019-02-01 00:48:58|2019-02-01 00:51:34|2019-02-01 01:28:29|261         |234         |5.01      |2159.0   |44.96              |0.0  |1.12|3.99     |0.0                 |0.0 |35.97     |N                  |Y                |N               |2019|2    |2019-02  |Friday   |0.0    |1.0                    |0.0                       |0.0                      |1.0                    |0.0                   |7.0            |1.0            |[5.01]          |[0.033395782357372866] |[2159.0]       |[0.025626112759643917] |[44.96]                  |[0.056255006007208654]    |[0.0]      |[0.0]                  |[1.12]   |[0.020467836257309944] |[3.99]         |[0.03484107579462103]  |[0.0]                     |[0.0]                      |[0.0]     |[0.0]                  |[35.97]         |[0.06009960891800648] |\n",
      "|HV0005           |B02510              |2019-02-01 00:02:15|2019-02-01 00:03:51|2019-02-01 00:07:16|87          |87          |0.34      |179.0    |7.19               |0.0  |0.18|0.64     |0.0                 |3.0 |5.39      |N                  |Y                |N               |2019|2    |2019-02  |Friday   |0.0    |1.0                    |0.0                       |0.0                      |1.0                    |0.0                   |7.0            |1.0            |[0.34]          |[0.0022601657454880027]|[179.0]        |[0.0021246290801186945]|[7.19]                   |[0.008985782939527434]    |[0.0]      |[0.0]                  |[0.18]   |[0.003289473684210526] |[0.64]         |[0.005588543485854]    |[0.0]                     |[0.0]                      |[3.0]     |[0.0071428571428571435]|[5.39]          |[0.008991543269712871]|\n",
      "|HV0005           |B02510              |2019-02-01 00:06:17|2019-02-01 00:09:44|2019-02-01 00:39:56|87          |198         |6.84      |1799.0   |24.25              |0.11 |0.61|2.16     |0.0                 |4.0 |17.07     |N                  |Y                |N               |2019|2    |2019-02  |Friday   |0.0    |1.0                    |0.0                       |0.0                      |1.0                    |0.0                   |7.0            |1.0            |[6.84]          |[0.04559667708965324]  |[1799.0]       |[0.021353115727002967] |[24.25]                  |[0.030336403684421306]    |[0.11]     |[1.1799536600017164E-4]|[0.61]   |[0.01114766081871345]  |[2.16]         |[0.01886133426475725]  |[0.0]                     |[0.0]                      |[4.0]     |[0.009523809523809525] |[17.07]         |[0.028512217134070924]|\n",
      "|HV0005           |B02510              |2019-02-01 00:07:17|2019-02-01 00:12:06|2019-02-01 00:42:13|161         |148         |4.53      |1799.0   |16.39              |0.0  |0.41|1.45     |0.0                 |0.0 |14.31     |N                  |Y                |N               |2019|2    |2019-02  |Friday   |0.0    |1.0                    |0.0                       |0.0                      |1.0                    |0.0                   |7.0            |1.0            |[4.53]          |[0.030195547673496054] |[1799.0]       |[0.021353115727002967] |[16.39]                  |[0.020499599519423307]    |[0.0]      |[0.0]                  |[0.41]   |[0.007492690058479531] |[1.45]         |[0.012661543835137967] |[0.0]                     |[0.0]                      |[0.0]     |[0.0]                  |[14.31]         |[0.02389945515927399] |\n",
      "|HV0005           |B02510              |2019-02-01 00:43:33|2019-02-01 00:45:35|2019-02-01 01:14:56|148         |21          |11.24     |1739.0   |29.77              |0.72 |0.76|2.71     |0.0                 |0.0 |22.09     |N                  |Y                |N               |2019|2    |2019-02  |Friday   |0.0    |1.0                    |0.0                       |0.0                      |1.0                    |0.0                   |7.0            |1.0            |[11.24]         |[0.0749321616918574]   |[1739.0]       |[0.020640949554896145] |[29.77]                  |[0.03724469363235883]     |[0.72]     |[7.723333047283961E-4] |[0.76]   |[0.013888888888888888] |[2.71]         |[0.02366398882291303]  |[0.0]                     |[0.0]                      |[0.0]     |[0.0]                  |[22.09]         |[0.0369020957983755]  |\n",
      "|HV0003           |B02867              |2019-02-01 00:00:35|2019-02-01 00:10:48|2019-02-01 00:20:23|226         |260         |1.59      |574.0    |6.99               |0.0  |0.17|0.62     |0.0                 |0.0 |6.51      |Y                  |N                |N               |2019|2    |2019-02  |Friday   |0.0    |0.0                    |20.0                      |1.0                      |0.0                    |0.0                   |7.0            |1.0            |[1.59]          |[0.01059411023475055]  |[574.0]        |[0.006813056379821959] |[6.99]                   |[0.008735482579094915]    |[0.0]      |[0.0]                  |[0.17]   |[0.0031067251461988307]|[0.62]         |[0.005413901501921062] |[0.0]                     |[0.0]                      |[0.0]     |[0.0]                  |[6.51]          |[0.010863388708760904]|\n",
      "|HV0003           |B02867              |2019-02-01 00:29:16|2019-02-01 00:32:32|2019-02-01 00:40:25|7           |223         |1.9       |474.0    |7.05               |0.0  |0.18|0.63     |0.0                 |0.0 |6.01      |Y                  |N                |N               |2019|2    |2019-02  |Friday   |0.0    |0.0                    |20.0                      |1.0                      |0.0                    |0.0                   |7.0            |1.0            |[1.9]           |[0.012660928468087659] |[474.0]        |[0.005626112759643917] |[7.05]                   |[0.00881057268722467]     |[0.0]      |[0.0]                  |[0.18]   |[0.003289473684210526] |[0.63]         |[0.005501222493887531] |[0.0]                     |[0.0]                      |[0.0]     |[0.0]                  |[6.01]          |[0.010027743423471604]|\n",
      "|HV0003           |B02867              |2019-02-01 00:55:48|2019-02-01 00:59:54|2019-02-01 01:09:31|129         |70          |2.74      |576.0    |10.36              |0.0  |0.26|0.92     |0.0                 |0.0 |7.77      |N                  |N                |N               |2019|2    |2019-02  |Friday   |0.0    |0.0                    |20.0                      |0.0                      |0.0                    |0.0                   |7.0            |1.0            |[2.74]          |[0.018261339164872093] |[576.0]        |[0.00683679525222552]  |[10.36]                  |[0.012953043652382859]    |[0.0]      |[0.0]                  |[0.26]   |[0.004751461988304093] |[0.92]         |[0.008033531260915125] |[0.0]                     |[0.0]                      |[0.0]     |[0.0]                  |[7.77]          |[0.01296921482768994] |\n",
      "|HV0003           |B02764              |2019-01-31 23:58:20|2019-02-01 00:01:11|2019-02-01 00:21:35|263         |229         |7.91      |1225.0   |9.48               |0.0  |0.63|2.22     |0.0                 |0.0 |20.05     |N                  |N                |N               |2019|2    |2019-02  |Friday   |0.0    |0.0                    |1.0                       |0.0                      |0.0                    |0.0                   |7.0            |1.0            |[7.91]          |[0.05273053357246198]  |[1225.0]       |[0.014540059347181009] |[9.48]                   |[0.011851722066479777]    |[0.0]      |[0.0]                  |[0.63]   |[0.011513157894736841] |[2.22]         |[0.019385260216556063] |[0.0]                     |[0.0]                      |[0.0]     |[0.0]                  |[20.05]         |[0.03349266303439515] |\n",
      "|HV0003           |B02764              |2019-02-01 00:33:43|2019-02-01 00:36:22|2019-02-01 00:55:30|162         |129         |7.21      |1148.0   |20.69              |5.76 |0.66|2.35     |0.0                 |0.0 |23.16     |N                  |N                |N               |2019|2    |2019-02  |Friday   |0.0    |0.0                    |1.0                       |0.0                      |0.0                    |0.0                   |7.0            |1.0            |[7.21]          |[0.04806352465847495]  |[1148.0]       |[0.013626112759643918] |[20.69]                  |[0.025881057268722467]    |[5.76]     |[0.006178666437827169] |[0.66]   |[0.01206140350877193]  |[2.35]         |[0.020520433112120155] |[0.0]                     |[0.0]                      |[0.0]     |[0.0]                  |[23.16]         |[0.0386903767088946]  |\n",
      "|HV0002           |B02914              |2019-02-01 00:05:50|2019-02-01 00:10:09|2019-02-01 00:31:04|161         |33          |6.93      |1254.0   |21.46              |0.0  |0.47|1.71     |0.0                 |3.55|17.71     |N                  |N                |N               |2019|2    |2019-02  |Friday   |0.0    |2.0                    |29.0                      |0.0                      |0.0                    |0.0                   |7.0            |1.0            |[6.93]          |[0.04619672109288014]  |[1254.0]       |[0.014884272997032641] |[21.46]                  |[0.026844713656387666]    |[0.0]      |[0.0]                  |[0.47]   |[0.008589181286549707] |[1.71]         |[0.014931889626266154] |[0.0]                     |[0.0]                      |[3.55]    |[0.008452380952380953] |[17.71]         |[0.02958184309924123] |\n",
      "|HV0003           |B02864              |2019-02-01 00:54:59|2019-02-01 00:57:50|2019-02-01 01:05:08|258         |197         |2.16      |438.0    |8.5                |0.0  |0.21|0.75     |0.0                 |0.0 |5.99      |N                  |N                |N               |2019|2    |2019-02  |Friday   |0.0    |0.0                    |9.0                       |0.0                      |0.0                    |0.0                   |7.0            |1.0            |[2.16]          |[0.014394388921854271] |[438.0]        |[0.005198813056379822] |[8.5]                    |[0.010625250300360434]    |[0.0]      |[0.0]                  |[0.21]   |[0.003837719298245614] |[0.75]         |[0.006549074397485156] |[0.0]                     |[0.0]                      |[0.0]     |[0.0]                  |[5.99]          |[0.009994317612060032]|\n",
      "|HV0003           |B02875              |2019-01-31 23:59:01|2019-02-01 00:05:24|2019-02-01 00:17:13|255         |17          |2.92      |710.0    |11.51              |0.0  |0.29|1.02     |0.0                 |0.0 |8.53      |N                  |N                |N               |2019|2    |2019-02  |Friday   |0.0    |0.0                    |3.0                       |0.0                      |0.0                    |0.0                   |7.0            |1.0            |[2.92]          |[0.019461427171325898] |[710.0]        |[0.008427299703264095] |[11.51]                  |[0.014392270724869845]    |[0.0]      |[0.0]                  |[0.29]   |[0.005299707602339181] |[1.02]         |[0.008906741180579813] |[0.0]                     |[0.0]                      |[0.0]     |[0.0]                  |[8.53]          |[0.014239395661329677]|\n",
      "|HV0003           |B02875              |2019-02-01 00:24:04|2019-02-01 00:27:38|2019-02-01 00:32:36|255         |112         |1.09      |298.0    |3.92               |0.0  |0.1 |0.35     |0.0                 |0.0 |5.64      |Y                  |N                |N               |2019|2    |2019-02  |Friday   |0.0    |0.0                    |3.0                       |1.0                      |0.0                    |0.0                   |7.0            |1.0            |[1.09]          |[0.007260532439045531] |[298.0]        |[0.003537091988130564] |[3.92]                   |[0.004893372046455747]    |[0.0]      |[0.0]                  |[0.1]    |[0.001827485380116959] |[0.35]         |[0.0030562347188264056]|[0.0]                     |[0.0]                      |[0.0]     |[0.0]                  |[5.64]          |[0.00940936591235752] |\n",
      "|HV0003           |B02875              |2019-02-01 00:47:49|2019-02-01 00:52:50|2019-02-01 00:56:02|234         |137         |0.37      |192.0    |7.81               |0.0  |0.2 |0.69     |0.0                 |0.0 |6.11      |N                  |N                |N               |2019|2    |2019-02  |Friday   |0.0    |0.0                    |3.0                       |0.0                      |0.0                    |0.0                   |7.0            |1.0            |[0.37]          |[0.0024601804132303035]|[192.0]        |[0.00227893175074184]  |[7.81]                   |[0.009761714056868242]    |[0.0]      |[0.0]                  |[0.2]    |[0.003654970760233918] |[0.69]         |[0.006025148445686343] |[0.0]                     |[0.0]                      |[0.0]     |[0.0]                  |[6.11]          |[0.010194872480529464]|\n",
      "|HV0003           |B02682              |2019-02-01 00:25:04|2019-02-01 00:30:24|2019-02-01 00:59:08|163         |256         |8.09      |1724.0   |26.34              |5.76 |0.8 |2.85     |0.0                 |0.0 |28.99     |N                  |N                |N               |2019|2    |2019-02  |Friday   |0.0    |0.0                    |7.0                       |0.0                      |0.0                    |0.0                   |7.0            |1.0            |[8.09]          |[0.05393062157891579]  |[1724.0]       |[0.020462908011869438] |[26.34]                  |[0.032952042450941126]    |[5.76]     |[0.006178666437827169] |[0.8]    |[0.014619883040935672] |[2.85]         |[0.02488648271044359]  |[0.0]                     |[0.0]                      |[0.0]     |[0.0]                  |[28.99]         |[0.04843400073536784] |\n",
      "|HV0003           |B02682              |2019-02-01 00:32:37|2019-02-01 00:35:06|2019-02-01 00:44:27|161         |262         |2.4       |561.0    |22.16              |0.0  |0.55|1.97     |0.0                 |0.0 |16.35     |N                  |N                |N               |2019|2    |2019-02  |Friday   |0.0    |0.0                    |7.0                       |0.0                      |0.0                    |0.0                   |7.0            |1.0            |[2.4]           |[0.015994506263792677] |[561.0]        |[0.006658753709198813] |[22.16]                  |[0.027720764917901482]    |[0.0]      |[0.0]                  |[0.55]   |[0.010051169590643274] |[1.97]         |[0.01720223541739434]  |[0.0]                     |[0.0]                      |[0.0]     |[0.0]                  |[16.35]         |[0.027308887923254335]|\n",
      "|HV0003           |B02764              |2019-01-31 23:57:50|2019-02-01 00:12:54|2019-02-01 00:22:32|4           |114         |1.17      |577.0    |5.85               |0.0  |0.15|0.52     |0.0                 |5.0 |12.2      |N                  |N                |N               |2019|2    |2019-02  |Friday   |0.0    |0.0                    |1.0                       |0.0                      |0.0                    |0.0                   |7.0            |1.0            |[1.17]          |[0.007793904886358333] |[577.0]        |[0.0068486646884273]   |[5.85]                   |[0.007308770524629556]    |[0.0]      |[0.0]                  |[0.15]   |[0.0027412280701754384]|[0.52]         |[0.0045406915822563745]|[0.0]                     |[0.0]                      |[5.0]     |[0.011904761904761906] |[12.2]          |[0.02037303205535314] |\n",
      "+-----------------+--------------------+-------------------+-------------------+-------------------+------------+------------+----------+---------+-------------------+-----+----+---------+--------------------+----+----------+-------------------+-----------------+----------------+----+-----+---------+---------+-------+-----------------------+--------------------------+-------------------------+-----------------------+----------------------+---------------+---------------+----------------+-----------------------+---------------+-----------------------+-------------------------+--------------------------+-----------+-----------------------+---------+-----------------------+---------------+-----------------------+--------------------------+---------------------------+----------+-----------------------+----------------+----------------------+\n",
      "only showing top 20 rows\n",
      "\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                                                \r"
     ]
    }
   ],
   "source": [
    "from pyspark.ml.feature import VectorAssembler, MinMaxScaler\n",
    "from pyspark.sql.functions import col\n",
    "\n",
    "# List of 'double' columns to scale\n",
    "double_columns = ['trip_miles', 'trip_time', 'base_passenger_fare', 'tolls', \n",
    "                  'bcf', 'sales_tax', 'congestion_surcharge', 'tips', 'driver_pay']\n",
    "\n",
    "# Apply VectorAssembler and MinMaxScaler for each 'double' column\n",
    "for col_name in double_columns:\n",
    "    # Assemble each column into a vector\n",
    "    assembler = VectorAssembler(inputCols=[col_name], outputCol=col_name + \"Vector\")\n",
    "    indexed_sdf = assembler.transform(indexed_sdf) \n",
    "    \n",
    "    # Scale the vector column\n",
    "    scaler = MinMaxScaler(inputCol=col_name + \"Vector\", outputCol=col_name + \"_scaled\")\n",
    "    indexed_sdf = scaler.fit(indexed_sdf).transform(indexed_sdf)\n",
    "\n",
    "# Show the resulting DataFrame with both original and scaled columns\n",
    "indexed_sdf.show(truncate=False)\n"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "PySpark",
   "language": "python",
   "name": "pyspark"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.8"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
